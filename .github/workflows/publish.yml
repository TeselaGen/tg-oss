name: Publish Packages
on:
  push:
    branches:
      # - master
      - beta

# Required for OIDC Trusted Publishing
permissions:
  contents: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22 # Use the current LTS
          registry-url: "https://registry.npmjs.org"

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      - name: Release and Publish
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

          # Determine release type and flags
          if [[ "${{ github.ref_name }}" == "beta" ]]; then
            RELEASE_TAG="beta"
            VERSION_FLAGS="--preid beta"
          else
            RELEASE_TAG="latest"
            VERSION_FLAGS=""
          fi

          # 1. Versioning
          # Use nx release version to update package.json files and changelogs
          npx nx release version --first-release $VERSION_FLAGS

          # 2. Build
          # Rebuild to ensure artifacts in dist/ contain the new version
          yarn nx run-many --target=publish --skip-nx-cache

          # 3. Publish
          # Manually publish each package using npm to avoid yarn/nx issues
          PROJECTS="sequence-utils bounce-loader bio-parsers range-utils file-utils uploader ove ui"

          for PROJECT in $PROJECTS; do
            echo "Publishing $PROJECT to tag $RELEASE_TAG..."
            # Navigate to the build output directory
            if [ -d "dist/$PROJECT" ]; then
              cd dist/$PROJECT
              npm publish --access public --tag $RELEASE_TAG
              cd - > /dev/null
            else
              echo "Warning: dist/$PROJECT not found, skipping..."
            fi
          done

          # Push the version changes and tags back to the repository
          git push --follow-tags origin HEAD:${{ github.ref_name }}
