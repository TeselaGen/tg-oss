name: Update gh-pages
on:
  push:
    branches:
      - master
jobs:
  update-gh-pages:
    strategy:
      matrix:
        package_name: [ove, ui]
    name: Update gh-pages
    runs-on: ubuntu-latest
    steps:
      # https://github.com/actions/checkout
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v6
      - uses: oven-sh/setup-bun@v2
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Check if version already deployed
        id: check
        run: |
          PACKAGE_NAME=${{ matrix.package_name }}
          VERSION=$(node -p "require('./packages/$PACKAGE_NAME/package.json').version")
          echo "Checking if $PACKAGE_NAME v$VERSION is already deployed..."

          # Fetch gh-pages branch to check for existence
          git fetch origin gh-pages --depth=1

          if git ls-tree -d origin/gh-pages:$PACKAGE_NAME/version/$VERSION >/dev/null 2>&1; then
            echo "Version $VERSION already exists on gh-pages."
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Version $VERSION not found. Proceeding with deployment."
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Version update detected
        if: steps.check.outputs.changed == 'true'
        run: 'echo "Version change found! New version: ${{ steps.check.outputs.version }}"'

      - uses: bahmutov/npm-install@v1
        if: steps.check.outputs.changed == 'true'
        with:
          install-command: yarn

      - run: yarn nx run ${{ matrix.package_name }}:build --configuration=demo
        if: steps.check.outputs.changed == 'true'

      - name: Deploy Version  ðŸš€
        if: steps.check.outputs.changed == 'true'
        uses: JamesIves/github-pages-deploy-action@v4.2.2
        with:
          branch: gh-pages # The branch the action should deploy to.
          folder: ./demo-dist/${{ matrix.package_name }} # The folder the action should deploy.
          target-folder: ${{ matrix.package_name }}/version/${{steps.check.outputs.version}}
      - name: Deploy Main App  ðŸš€
        if: steps.check.outputs.changed == 'true'
        uses: JamesIves/github-pages-deploy-action@v4.2.2
        with:
          branch: gh-pages # The branch the action should deploy to.
          folder: ./demo-dist/${{ matrix.package_name }} # The folder the action should deploy.
          target-folder: ${{ matrix.package_name }}/
          clean: true # Automatically remove deleted files from the deploy branch
          clean-exclude: version
